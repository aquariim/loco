+++
title = "A Quick Tour with Loco on RockyLinux 9"
date = 2021-05-01T08:00:00+00:00
updated = 2021-05-01T08:00:00+00:00
draft = false
weight = 1
sort_by = "weight"
template = "docs/page.html"

[extra]
toc = true
top = false
+++

<img style="width:100%; max-width:640px" src="tour.png"/>
<br/>
<br/>
<br/>

OS preworks to install sqlite3, nodejs, npm, pnpm and redis server.

```
$ cat /etc/redhat-release
Rocky Linux release 9.3 (Blue Onyx)
$sudo dnf module reset nodejs &&  sudo dnf module enable -y nodejs:20
$sudo dnf install -y nodejs
$sudo systemctl enable --now  redis
$ sqlite3  --version |awk '{print $1,$2}'
3.34.1 2021-01-20
$ ncat -zv 127.0.0.1 6379
Ncat: Version 7.92 ( https://nmap.org/ncat )
Ncat: Connected to 127.0.0.1:6379.
Ncat: 0 bytes sent, 0 bytes received in 0.03 seconds.
$

```
Let's create a blog on `loco` in 4 commands. First install `loco-cli` and `sea-orm-cli`:

```sh
$ cargo install cargo-watch && cargo install loco-cli &&  cargo install sea-orm-cli
$ loco -V
loco-cli 0.2.5
$

```


Change directory to /tmp and create your new app (choose "Saas app").

```sh
$ pwd && loco new
/tmp
✔ ❯ App name? · myapp
✔ ❯ What would you like to build? · Saas app (with DB and user auth)

🚂 Loco app generated successfully in:
/tmp/myapp
$
```

<div class="infobox">
We are going to use sqlite db by chaning DATABASE_URL.
</div>

Using tree command to see directory layout generated by loco new.
```
$ tree -L 2
.
├── Cargo.toml
├── config
│   ├── development.yaml
│   ├── production.yaml
│   └── test.yaml
├── examples
│   └── playground.rs
├── frontend
│   ├── dist
│   ├── favicon.ico
│   ├── index.html
│   ├── package.json
│   ├── pnpm-lock.yaml
│   ├── README.md
│   ├── src
│   └── vite.config.js
├── migration
│   ├── Cargo.toml
│   ├── README.md
│   └── src
├── README.md
├── src
│   ├── app.rs
│   ├── bin
│   ├── controllers
│   ├── fixtures
│   ├── lib.rs
│   ├── mailers
│   ├── models
│   ├── tasks
│   ├── views
│   └── workers
└── tests
    ├── models
    ├── mod.rs
    ├── requests
    └── tasks

20 directories, 17 files
$
```

```
$docker run -d -p 5432:5432 -e POSTGRES_USER=loco -e POSTGRES_DB=myapp_development -e POSTGRES_PASSWORD="loco" postgres:15.3-alpine
```
Change DATABASE_URL to use sqlite

```
# Old
$ egrep DATABASE_URL config/development.yaml
  uri: {{ get_env(name="DATABASE_URL", default="postgres://loco:loco@localhost:5432/myapp_development") }}
# New
$ egrep -r DATABASE_URL todolist/config/development.yaml
  uri: {{ get_env(name="DATABASE_URL", default="sqlite://./myapp.db?mode=rwc") }}
$
```

Now `cd` into your `myapp` and run **cargo loco doctor**
```
$ cargo loco doctor
<snipped>
    Finished dev [unoptimized + debuginfo] target(s) in 0.32s
     Running `target/debug/myapp-cli doctor`
✅ SeaORM CLI is installed
✅ DB connection: success
✅ Redis connection: success
$
```

See sqlite db.sqlite initial tables.

```
$ sqlite3 ./db.sqlite
SQLite version 3.34.1 2021-01-20 14:10:07
Enter ".help" for usage hints.
sqlite> .table;
Error: unknown command or invalid arguments:  "table;". Enter ".help" for help
sqlite> .table
notes             seaql_migrations  users
sqlite> select * from users;
sqlite> select * from notes;
sqlite> select * from seaql_migrations;
m20220101_000001_users|1703421564
m20231103_114510_notes|1703421564
sqlite> .quit
$

```

Start your app using cargo-watch for auto update and restart:

```
$ cd myapp
$ cargo-watch -x check  -s 'cargo loco start'
or 
$ cargo-watch -x check  -s 'myapp2-cli start'
[Running 'cargo check && cargo loco start']
    Finished dev [unoptimized + debuginfo] target(s) in 0.44s
    Finished dev [unoptimized + debuginfo] target(s) in 0.31s
     Running `target/debug/myapp-cli start`
2023-12-25T00:35:16.517632Z  WARN loco_rs::boot: pretty backtraces are enabled (this is great for development but has a runtime cost for production. disable with `logger.pretty_backtrace` in your config yaml)
2023-12-25T00:35:16.519978Z  INFO loco_rs::db: auto migrating
2023-12-25T00:35:16.526711Z  INFO sea_orm_migration::migrator: Applying all pending migrations
2023-12-25T00:35:16.530111Z  INFO sea_orm_migration::migrator: Applying migration 'm20220101_000001_users'
2023-12-25T00:35:16.533459Z  INFO sea_orm_migration::migrator: Migration 'm20220101_000001_users' has been applied
2023-12-25T00:35:16.536245Z  INFO sea_orm_migration::migrator: Applying migration 'm20231103_114510_notes'
2023-12-25T00:35:16.539231Z  INFO sea_orm_migration::migrator: Migration 'm20231103_114510_notes' has been applied
2023-12-25T00:35:16.562971Z  INFO loco_rs::controller::app_routes: [GET] /api/_ping
2023-12-25T00:35:16.563117Z  INFO loco_rs::controller::app_routes: [GET] /api/_health
2023-12-25T00:35:16.563163Z  INFO loco_rs::controller::app_routes: [GET] /api/notes
2023-12-25T00:35:16.563220Z  INFO loco_rs::controller::app_routes: [POST] /api/notes
2023-12-25T00:35:16.563254Z  INFO loco_rs::controller::app_routes: [GET] /api/notes/:id
2023-12-25T00:35:16.563312Z  INFO loco_rs::controller::app_routes: [DELETE] /api/notes/:id
2023-12-25T00:35:16.563363Z  INFO loco_rs::controller::app_routes: [POST] /api/notes/:id
2023-12-25T00:35:16.563380Z  INFO loco_rs::controller::app_routes: [POST] /api/auth/register
2023-12-25T00:35:16.563523Z  INFO loco_rs::controller::app_routes: [POST] /api/auth/verify
2023-12-25T00:35:16.563639Z  INFO loco_rs::controller::app_routes: [POST] /api/auth/login
2023-12-25T00:35:16.563725Z  INFO loco_rs::controller::app_routes: [POST] /api/auth/forgot
2023-12-25T00:35:16.563765Z  INFO loco_rs::controller::app_routes: [POST] /api/auth/reset
2023-12-25T00:35:16.563862Z  INFO loco_rs::controller::app_routes: [GET] /api/user/current
2023-12-25T00:35:16.564185Z  INFO loco_rs::controller::app_routes: [Middleware] Adding limit payload data="5mb"
2023-12-25T00:35:16.564358Z  INFO loco_rs::controller::app_routes: [Middleware] Adding log trace id
2023-12-25T00:35:16.564450Z  INFO loco_rs::controller::app_routes: [Middleware] Adding timeout layer
2023-12-25T00:35:16.564671Z  INFO loco_rs::controller::app_routes: [Middleware] Adding cors
2023-12-25T00:35:16.564784Z  INFO loco_rs::controller::app_routes: [Middleware] Adding static
<snipped>
environment: development
   database: automigrate
     logger: debug
compilation: debug
      modes: server

listening on port 3000
```

<div class="infobox">
You don't have to run things through `cargo` but in development it's highly recommended. If you build `--release`, your binary contains everything including your code and `cargo` or Rust is not needed.
</div>

## Adding a CRUD API

We have a base SaaS app with user authentication generated for us. Let's make it a blog by adding a `post` and a full CRUD API using `scaffold`:

```sh
$ cargo loco generate scaffold post title:string 
Warning: can't set `imports_granularity = Crate`, unstable features are only available in nightly channel.
Warning: can't set `group_imports = StdExternalCrate`, unstable features are only available in nightly channel.
... Done.
2023-12-25T00:57:30.834294Z  WARN loco_rs::boot:
added: "src/controllers/post.rs"
injected: "src/controllers/mod.rs"
injected: "src/app.rs"
added: "tests/requests/post.rs"
injected: "tests/requests/mod.rs"
* Migration for `post` added! You can now apply it with `$ cargo loco db migrate`.
* A test for model `Posts` was added. Run with `cargo test`.
* Controller `Post` was added successfully.
* Tests for controller `Post` was added successfully. Run `cargo run test`.
$

```


Your database have been migrated and model, entities, and a full blog post CRUD controller have been generated automatically.

```
2023-12-25T00:58:01.390896Z  INFO loco_rs::controller::app_routes: [POST] /api/posts
2023-12-25T00:58:01.390930Z  INFO loco_rs::controller::app_routes: [GET] /api/posts/:id
2023-12-25T00:58:01.391051Z  INFO loco_rs::controller::app_routes: [DELETE] /api/posts/:id
2023-12-25T00:58:01.391188Z  INFO loco_rs::controller::app_routes: [POST] /api/posts/:id

```

Build your app into a binary and list out its usage.
```
$ cargo install --path .
  Installing /home/me/.cargo/bin/myapp-cli
   Installed package `myapp v0.1.0 (/tmp/myapp)` (executable `myapp-cli`)
$ myapp-cli
The one-person framework for Rust

Usage: myapp-cli [OPTIONS] <COMMAND>

Commands:
  start     Start an app
  db        Perform DB operations
  routes    Describe all application endpoints
  task      Run a custom task
  generate  code generation creates a set of files and code templates based on a predefined set of rules
  doctor    Validate and diagnose configurations
  version   Display the app version
  help      Print this message or the help of the given subcommand(s)

Options:
  -e, --environment <ENVIRONMENT>  Specify the environment [default: development]
  -h, --help                       Print help
  -V, --version                    Print version
$

```

List out current API endpoints
```
$ myapp-cli routes
[GET] /api/_health
[GET] /api/_ping
[POST] /api/auth/forgot
[POST] /api/auth/login
[POST] /api/auth/register
[POST] /api/auth/reset
[POST] /api/auth/verify
[GET] /api/notes
[POST] /api/notes
[GET] /api/notes/:id
[DELETE] /api/notes/:id
[POST] /api/notes/:id
[GET] /api/posts
[POST] /api/posts
[GET] /api/posts/:id
[DELETE] /api/posts/:id
[POST] /api/posts/:id
[GET] /api/user/current
$

```
Start your app by cargo or myapp-cli:

```sh
$ cd /tmp/myapp && cargo loco start
or
$ cd /tmp/myapp && myapp-cli start
```

Next, try *(**C**RUD) add a blog post by `curl`:

```sh
$ curl -X POST -H "Content-Type: application/json" -d '{ "title": "Your Title", "content": "Your Content xxx"}' localhost:3000/api/posts ;echo
{"created_at":"2023-12-25T01:06:29.247901","updated_at":"2023-12-25T01:06:29.247901","id":3,"title":"Your Title"}
$

```

You can list(C**R**UD) your posts:

```sh
$ curl localhost:3000/api/posts
```

For those counting -- the commands for creating a blog were:

1. `cargo install loco-cli`
2. `cargo install sea-orm-cli`
3. `loco new`
4. `cargo loco generate scaffold post title:string content:text`

Done! enjoy your ride with `loco` 🚂

## Checking Out SaaS Authentication

Your generated app contains a fully working authentication suite, based on JWTs.

### Registering a New User

The `/api/auth/register` endpoint creates a new user in the database with an `email_verification_token` for account verification. A welcome email is sent to the user with a verification link.

```sh
$ curl --location '127.0.0.1:3000/api/auth/register' \
     --header 'Content-Type: application/json' \
     --data-raw '{
         "name": "Loco user 1",
         "email": "user@loco.rs",
         "password": "12341234"
     }'
```

For security reasons, if the user is already registered, no new user is created, and a 200 status is returned without exposing user email details.

### Login

After registering a new user, use the following request to log in:

```sh
$ curl --location '127.0.0.1:3000/api/auth/login' \
     --header 'Content-Type: application/json' \
     --data-raw '{
         "email": "user@loco.rs",
         "password": "12341234"
     }'
```

The response includes a JWT token for authentication, user ID, name, and verification status.

```sh
{
    "token": "xxxx",
    "pid": "2b20f998-b11e-4aeb-96d7-beca7671abda",
    "name": "Loco user",
    "is_verified": false
}
```

### Get current user

This endpoint is protected by auth middleware.

```sh
TOKEN=xxxx # long token value returned above
$ curl --location --request GET '127.0.0.1:3000/api/user/current' \
     --header 'Content-Type: application/json' \
     --header 'Authorization: Bearer TOKEN' \
```

Check out the source code for `controllers/auth.rs` to see how to use the authentication middleware in your own controllers.
